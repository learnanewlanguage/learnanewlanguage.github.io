<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Italian Language Course</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Tone.js for sound effects -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <style>
        /* Global box-sizing for consistent layout behavior */
        html {
            box-sizing: border-box;
        }
        *, *::before, *::after {
            box-sizing: inherit;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #eef2f6; /* Lighter blue-grey background */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 1rem; /* Keeps a general margin around the main container */
            overflow-x: hidden; /* Prevents horizontal scrolling on small screens */
        }
        .container-wrapper {
            /* This div acts as the primary container, centered and responsive */
            background-color: #ffffff;
            border-radius: 1.5rem; /* More rounded corners */
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1); /* Deeper shadow */
            max-width: 900px; /* Increased max-width */
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        /* Tailwind's padding classes will be applied directly to #app-container */
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem; /* Rounded button corners */
            font-weight: 600;
            transition: all 0.2s ease-in-out;
            text-align: center;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            position: relative; /* For button effects */
            overflow: hidden; /* For ripple effect */
        }
        .btn:active {
            transform: translateY(1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .btn-primary {
            background-color: #4CAF50; /* Duolingo green */
            color: #ffffff;
        }
        .btn-primary:hover {
            background-color: #45a049;
            transform: translateY(-2px);
        }
        .btn-secondary {
            background-color: #f9fafb; /* Lighter secondary button */
            color: #4a5568;
            border: 1px solid #e2e8f0;
        }
        .btn-secondary:hover {
            background-color: #edf2f7;
            transform: translateY(-2px);
        }
        .choice-btn {
            width: 100%;
            display: flex;
            align-items: center; /* Align number and text vertically */
            padding: 1rem;
            border-radius: 0.75rem;
            border: 2px solid #e2e8f0; /* Lighter border */
            background-color: #ffffff; /* White background for choices */
            font-size: 1.125rem;
            font-weight: 500;
            transition: all 0.2s ease-in-out;
            cursor: pointer;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05); /* Subtle shadow */
        }
        .choice-btn .choice-number {
            margin-right: 0.75rem; /* Space between number and text */
            font-weight: 700;
            color: #888;
            min-width: 1.5rem; /* Ensure consistent spacing for numbers */
            text-align: center;
            background-color: #f0f4f8; /* Light background for number */
            padding: 0.25rem 0.5rem;
            border-radius: 0.5rem;
        }
        .choice-btn:hover {
            background-color: #f5f8fb; /* Very light hover background */
            border-color: #a0aec0; /* Slightly darker border on hover */
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        .choice-btn.selected {
            background-color: #e6f7ff; /* Light blue for selected */
            border-color: #3b82f6; /* Blue border for selected (Tailwind blue-500) */
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.15);
        }
        .choice-btn.correct {
            background-color: #d4edda; /* Light green for correct */
            border-color: #22c55e; /* Tailwind green-500 */
            color: #155724;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.15);
        }
        .choice-btn.incorrect {
            background-color: #fce7e7; /* Light red for incorrect */
            border-color: #ef4444; /* Tailwind red-500 */
            color: #721c24;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.15);
        }
        input[type="text"],
        input[type="email"],
        input[type="password"] {
            border-radius: 0.75rem;
            padding: 0.75rem 1rem;
            border: 2px solid #e2e8f0;
            width: 100%;
            font-size: 1.125rem;
            background-color: #fdfdfe; /* Slightly off-white background */
            transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        input[type="text"]:focus,
        input[type="email"]:focus,
        input[type="password"]:focus {
            outline: none;
            border-color: #3b82f6; /* Blue border on focus */
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2); /* Blue ring on focus */
        }
        .progress-bar {
            height: 0.75rem;
            background-color: #e2e8f0; /* Lighter background */
            border-radius: 0.375rem;
            overflow: hidden;
            box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.05); /* Inner shadow */
        }
        .progress-fill {
            height: 100%;
            background-color: #4CAF50;
            border-radius: 0.375rem;
            transition: width 0.3s ease-in-out;
        }
        .vocabulary-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #e2e8f0; /* Lighter separator */
            font-size: 1.125rem;
        }
        .vocabulary-item:last-child {
            border-bottom: none;
        }
        .vocabulary-word {
            font-weight: 600;
            color: #333;
        }
        .vocabulary-translation {
            color: #555;
            font-style: italic;
        }
        #speech-display {
            background-color: #f8fafc; /* Very light background */
            border: 1px solid #e2e8f0;
            border-radius: 0.75rem;
            padding: 1.25rem; /* More padding */
            min-height: 80px; /* Taller */
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem; /* Larger text */
            font-weight: 500;
            color: #4a5568;
            margin-bottom: 1rem;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.05);
            word-break: break-word; /* Ensure long words break */
        }
        #speaking-controls {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.75rem;
        }
        .skip-btn {
            background-color: #cbd5e0; /* Light grey */
            color: #4a5568;
            border: 1px solid #a0aec0;
            padding: 0.6rem 1.2rem;
            border-radius: 0.5rem;
            font-weight: 500;
            transition: all 0.2s ease-in-out;
            cursor: pointer;
            margin-top: 1rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
        }
        .skip-btn:hover {
            background-color: #a0aec0;
            color: #ffffff;
            transform: translateY(-1px);
        }
        /* Auth status box styling */
        .auth-info-box {
            border: 1px solid #e2e8f0;
            border-radius: 1rem; /* Consistent rounding */
            padding: 1.25rem; /* More padding */
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
            display: flex; /* Make it a flex container */
            align-items: center; /* Vertically align items */
            justify-content: space-between; /* Space items out */
        }
        .auth-info-box.flex-col { /* For mobile/small screens */
            flex-direction: column;
            align-items: center;
            text-align: center;
        }
        .auth-info-box .info-text {
            flex-grow: 1; /* Allows text to take up available space */
        }
        @media (min-width: 768px) { /* md breakpoint */
            .auth-info-box.flex-col {
                flex-direction: row;
                align-items: center;
                text-align: left;
            }
            .auth-info-box .info-text {
                margin-right: 1rem; /* Space between text and button on desktop */
            }
        }
    </style>
</head>
<body class="selection:bg-green-200 selection:text-green-800">
    <!-- Main application container with responsive padding -->
    <div id="app-container" class="container-wrapper p-4 sm:p-8 md:p-10">

        <!-- Authentication UI Area -->
        <div class="mb-4">
            <!-- Guest Prompt Banner (shown for anonymous users) -->
            <div id="guest-prompt-banner" class="auth-info-box bg-yellow-100 flex-col text-yellow-800 hidden">
                <p class="font-semibold info-text mb-2 md:mb-0">Create an account or login to continue on any device!</p>
                <!-- This button now links directly to account.html -->
                <button id="continue-to-account-btn" class="btn btn-primary text-sm px-4 py-2 w-full md:w-auto" onclick="window.location.href='account.html'">Continue</button>
            </div>

            <!-- Signed-in User Info (shown for authenticated users) -->
            <div id="signed-in-info" class="auth-info-box bg-gray-50 flex-col text-sm text-gray-600 hidden">
                <div class="flex flex-col info-text mb-2 md:mb-0">
                    <span id="auth-status-span" class="font-semibold text-gray-800 mb-1">Loading authentication status...</span>
                    <span id="user-id-display-span" class="text-gray-600 text-xs break-all">Loading User ID...</span>
                </div>
                <button id="signout-btn" class="btn btn-secondary text-sm mt-4 md:mt-0 w-full md:w-auto">Sign Out</button>
            </div>

            <!-- Authentication Controls (Email/Password inputs + Sign Up/In buttons - always hidden on this page) -->
            <form id="auth-controls" class="hidden">
                <!-- These inputs are now entirely removed from this page's visible flow -->
                <!-- They would reside on your dedicated account.html page -->
                <input type="email" id="email-input" placeholder="Email">
                <input type="password" id="password-input" placeholder="Password">
                <button id="signup-email-btn" class="btn btn-primary text-sm">Sign Up</button>
                <button id="signin-email-btn" class="btn btn-secondary text-sm">Sign In</button>
            </form>
            <!-- Authentication Error Message -->
            <div id="auth-error-message" class="hidden text-center text-red-500 font-medium text-sm mt-2 bg-red-50 p-2 rounded-lg border border-red-200"></div>
        </div>


        <!-- Progress Info and Bar -->
        <div class="flex items-center mb-4 pt-2">
            <div id="lesson-progress-text" class="text-gray-700 font-medium mr-4 flex-shrink-0 text-sm sm:text-base"></div>
            <div class="progress-bar flex-grow">
                <div id="progress-fill" class="progress-fill" style="width: 0%;"></div>
            </div>
        </div>

        <!-- Home Screen -->
        <div id="home-screen" class="text-center p-6">
            <h1 class="text-4xl md:text-5xl font-bold text-gray-800 mb-6">Learn Italian ðŸ‡®ðŸ‡¹</h1>
            <p class="text-lg md:text-xl text-gray-600 mb-8">Your journey to speaking Italian starts here with fun and interactive lessons!</p>
            <button id="start-course-btn" class="btn btn-primary text-xl px-10 py-4" onclick="startCourse()">Start Learning</button>
        </div>

        <!-- Lesson Screen -->
        <div id="lesson-screen" class="hidden p-6">
            <h2 id="lesson-title" class="text-3xl font-semibold text-gray-800 mb-4"></h2>
            <p id="lesson-description" class="text-lg text-gray-700 mb-8"></p>
            <div id="vocabulary-list" class="bg-gray-50 p-4 sm:p-6 rounded-xl mb-6 shadow-inner border border-gray-100">
                <h3 class="text-xl font-semibold text-gray-700 mb-4">New Vocabulary:</h3>
                <!-- Vocabulary items will be rendered here -->
            </div>
            <button id="continue-lesson-btn" class="btn btn-primary w-full" onclick="startCurrentLesson()">Start Exercises</button>
        </div>

        <!-- Question Screen -->
        <div id="question-screen" class="hidden p-6">
            <p id="question-text" class="text-2xl font-semibold text-gray-800 mb-6"></p>
            <div id="choices-container" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <!-- Choices will be rendered here -->
            </div>
            <input type="text" id="answer-input" placeholder="Type your answer here..." class="hidden mb-6">

            <!-- Speaking Exercise Controls -->
            <div id="speaking-exercise-container" class="hidden flex flex-col items-center">
                <div id="speech-display" class="w-full text-gray-500">Press 'Start Speaking' to begin...</div>
                <div id="speaking-controls" class="flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-4 mt-4">
                    <button id="start-speaking-btn" class="btn btn-primary text-lg" onclick="startSpeaking()">Start Speaking ðŸŽ¤</button>
                    <p id="speech-status" class="text-sm text-gray-600 hidden self-center">Listening...</p>
                </div>
                <p id="no-speech-support-message" class="text-sm text-red-500 mt-2 hidden">Speech recognition not supported in this browser.</p>
                <button id="skip-speaking-btn" class="skip-btn hidden" onclick="nextQuestion()">Skip Exercise</button>
            </div>

            <div id="feedback-message" class="text-center text-lg font-semibold mt-4 hidden"></div>
            <button id="check-answer-btn" class="btn btn-primary w-full mt-4" onclick="checkAnswer()">Check Answer</button>
            <button id="next-question-btn" class="btn btn-secondary w-full mt-4 hidden" onclick="nextQuestion()">Next</button>
        </div>

        <!-- Course Complete Screen -->
        <div id="course-complete-screen" class="hidden text-center p-6">
            <h2 class="text-4xl md:text-5xl font-bold text-green-600 mb-6">Congratulations! ðŸŽ‰</h2>
            <p class="text-lg md:text-xl text-gray-700 mb-8">You have completed all the lessons in this course. Fantastico!</p>
            <button id="restart-course-btn" class="btn btn-primary text-xl px-8 py-4" onclick="restartCourse()">Restart Course</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
        import { getAuth, signInAnonymously, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";

        // Your web app's Firebase configuration - HARDCODED FOR GITHUB PAGES DEPLOYMENT
        // WARNING: Hardcoding API keys in public client-side code is generally NOT secure for production.
        // For production apps, consider environment variables or a backend proxy.
        const firebaseConfig = {
            apiKey: "AIzaSyC0k-ukp9FyhOA8nL-872qutckblOMg3iw",
            authDomain: "learnanewlanguage-912d9.firebaseapp.com",
            projectId: "learnanewlanguage-912d9",
            storageBucket: "learnanewlanguage-912d9.firebasestorage.app",
            messagingSenderId: "368893428401",
            appId: "1:368893428401:web:4b9b5a1f15d82a17121890",
            measurementId: "G-5SVS0D0F0D"
        };

        // Course data and constants - MOVED TO TOP FOR PROPER INITIALIZATION
        const courses = [
            {
                title: "Lesson 1: Basic Greetings ðŸ‘‹",
                description: "Learn how to say hello, goodbye, and thank you.",
                vocabulary: [
                    { word: "Ciao", translation: "Hello / Goodbye" },
                    { word: "Grazie", translation: "Thank you" },
                    { word: "Prego", translation: "You're welcome / Please" },
                    { word: "Arrivederci", translation: "Goodbye" }
                ],
                questions: [
                    { type: "multiple-choice", text: "How do you say 'Hello' in Italian? ðŸ‘‹", choices: ["Ciao", "Grazie", "Prego", "Arrivederci"], correctAnswer: "Ciao" },
                    { type: "multiple-choice", text: "What does 'Grazie' mean? ðŸ™", choices: ["Hello", "Thank you", "Please", "Goodbye"], correctAnswer: "Thank you" },
                    { type: "translation-input", text: "Translate 'Please' into Italian:", correctAnswer: "Per favore" },
                    { type: "speaking", text: "Say 'Goodbye' in Italian: ðŸ‘‹", correctAnswer: "Arrivederci" }
                ]
            },
            {
                title: "Lesson 2: Numbers 1-5 ðŸ”¢",
                description: "Learn to count from one to five.",
                vocabulary: [
                    { word: "Uno", translation: "One" },
                    { word: "Due", translation: "Two" },
                    { word: "Tre", translation: "Three" },
                    { word: "Quattro", translation: "Four" },
                    { word: "Cinque", translation: "Five" }
                ],
                questions: [
                    { type: "multiple-choice", text: "What is 'One' in Italian? â˜ï¸", choices: ["Due", "Uno", "Tre", "Quattro"], correctAnswer: "Uno" },
                    { type: "speaking", text: "Say 'Two' in Italian:âœŒï¸", correctAnswer: "Due" },
                    { type: "translation-input", text: "Translate 'Three' into Italian:", correctAnswer: "Tre" },
                    { type: "translation-input", text: "Translate 'Four' into Italian:", correctAnswer: "Quattro" },
                    { type: "multiple-choice", text: "What is 'Cinque'? ðŸ–ï¸", choices: ["Three", "Four", "Five", "Six"], correctAnswer: "Five" }
                ]
            },
            {
                title: "Lesson 3: Common Phrases ðŸ—£ï¸",
                description: "Learn useful everyday phrases.",
                vocabulary: [
                    { word: "SÃ¬", translation: "Yes" },
                    { word: "No", translation: "No" },
                    { word: "Scusi", translation: "Excuse me / Sorry (formal)" },
                    { word: "Mi dispiace", translation: "I'm sorry" },
                    { word: "Per favore", translation: "Please" }
                ],
                questions: [
                    { type: "translation-input", text: "Translate 'Yes' into Italian: âœ…", correctAnswer: "SÃ¬" },
                    { type: "speaking", text: "Say 'No' in Italian:âŒ", correctAnswer: "No" },
                    { type: "multiple-choice", text: "How do you say 'Excuse me' (formal)? ðŸ™‡", choices: ["Scusi", "Aiuto", "Acqua", "Pane"], correctAnswer: "Scusi" },
                    { type: "multiple-choice", text: "What does 'Mi dispiace' mean? ðŸ˜”", choices: ["I'm happy", "I'm sorry", "I'm hungry", "I'm tired"], correctAnswer: "I'm sorry" }
                ]
            }
        ];

        const FUZZY_MATCH_THRESHOLD = 70;
        const positiveFeedbackMessages = [
            "Fantastic!", "You got this!", "Excellent!", "Keep up the great work!", "Perfect!"
        ];
        // Tone.js synths - initialized early but context resumed on user interaction
        const correctSynth = new Tone.Synth().toDestination();
        const incorrectSynth = new Tone.Synth().toDestination();


        // Initialize Firebase variables to null, they will be assigned if config is present
        let app = null;
        let db = null;
        let auth = null;
        // The following variables are moved to the top for proper initialization order
        let currentLessonIndex = 0;
        let currentQuestionIndex = 0;
        let userProgress = {}; // Will store progress as { lessonIndex: true }
        let selectedChoice = null;
        let currentSpeechRecognition = null;
        let userId = crypto.randomUUID(); // Default to a random ID for unauthenticated state
        let isAuthReady = false; // Flag to indicate if auth state has been determined

        // Store references to global functions for use in inline event handlers
        window.startCourse = startCourse;
        window.startCurrentLesson = startCurrentLesson;
        window.checkAnswer = checkAnswer;
        window.nextQuestion = nextQuestion;
        window.restartCourse = restartCourse;
        window.startSpeaking = startSpeaking;

        // Get DOM elements
        const homeScreen = document.getElementById('home-screen');
        const lessonScreen = document.getElementById('lesson-screen');
        const questionScreen = document.getElementById('question-screen');
        const courseCompleteScreen = document.getElementById('course-complete-screen');

        const startCourseBtn = document.getElementById('start-course-btn');
        const continueLessonBtn = document.getElementById('continue-lesson-btn');
        const lessonTitle = document.getElementById('lesson-title');
        const lessonDescription = document.getElementById('lesson-description');
        const vocabularyList = document.getElementById('vocabulary-list');

        const questionText = document.getElementById('question-text');
        const choicesContainer = document.getElementById('choices-container');
        const answerInput = document.getElementById('answer-input');
        const feedbackMessage = document.getElementById('feedback-message');
        const checkAnswerBtn = document.getElementById('check-answer-btn');
        const nextQuestionBtn = document.getElementById('next-question-btn');
        const restartCourseBtn = document.getElementById('restart-course-btn');
        const progressFill = document.getElementById('progress-fill');
        const lessonProgressText = document.getElementById('lesson-progress-text');

        const speakingExerciseContainer = document.getElementById('speaking-exercise-container');
        const speechDisplay = document.getElementById('speech-display');
        const startSpeakingBtn = document.getElementById('start-speaking-btn');
        const speechStatus = document.getElementById('speech-status');
        const noSpeechSupportMessage = document.getElementById('no-speech-support-message');
        const skipSpeakingBtn = document.getElementById('skip-speaking-btn');

        const guestPromptBanner = document.getElementById('guest-prompt-banner');
        const signedInInfo = document.getElementById('signed-in-info');
        const authStatusSpan = document.getElementById('auth-status-span');
        const userIdDisplaySpan = document.getElementById('user-id-display-span');
        const signoutBtn = document.getElementById('signout-btn'); // Get reference to the sign-out button
        const authErrorMessage = document.getElementById('auth-error-message');
        const authControls = document.getElementById('auth-controls');

        // Function to display authentication errors (still useful for Firebase errors)
        function displayAuthError(errorObject) {
            let message = '';
            if (errorObject && errorObject.code) {
                switch(errorObject.code) {
                    case 'auth/admin-restricted-operation':
                        message = 'Authentication failed: Anonymous sign-in is not enabled for this Firebase project. Please enable it in your Firebase Console under "Authentication" -> "Sign-in method".';
                        break;
                    case 'auth/network-request-failed':
                        message = 'Network error. Please check your internet connection.';
                        break;
                    case 'auth/internal-error':
                        message = 'An internal authentication error occurred. Please try again later.';
                        break;
                    default:
                        message = `Authentication Error: ${errorObject.message}`;
                }
            } else if (typeof errorObject === 'string') {
                message = errorObject;
            } else {
                message = 'An unknown authentication error occurred.';
            }

            if (authErrorMessage) {
                authErrorMessage.textContent = message;
                authErrorMessage.classList.remove('hidden');
                setTimeout(() => {
                    authErrorMessage.classList.add('hidden');
                    authErrorMessage.textContent = '';
                }, 10000); // Display for 10 seconds for critical errors
            }
        }

        // Function to handle sign out logic
        async function signOutUser() {
            if (!auth) {
                displayAuthError("Firebase authentication not initialized.");
                return;
            }
            try {
                await signOut(auth);
                console.log("User signed out.");
            } catch (error) {
                console.error("Sign out error:", error);
                displayAuthError(error); // Pass the error object
            }
        }

        // Attach event listener for sign-out button directly here, once DOM is ready
        // This ensures signOutUser is defined before the listener is attached.
        if (signoutBtn) {
            signoutBtn.addEventListener('click', signOutUser);
        }


        // Function to ensure AudioContext is resumed (addresses browser warning)
        function resumeAudioContext() {
            if (Tone.context.state !== 'running') {
                Tone.context.resume();
            }
        }

        function playCorrectSound() {
            resumeAudioContext(); // Ensure audio context is running
            correctSynth.triggerAttackRelease("C5", "8n");
        }

        function playIncorrectSound() {
            resumeAudioContext(); // Ensure audio context is running
            incorrectSynth.triggerAttackRelease("C3", "16n");
        }

        async function saveProgress() {
            // Only attempt to save to Firestore if auth and db are initialized and user is authenticated
            if (auth && db && auth.currentUser && !auth.currentUser.isAnonymous) {
                const userDocRef = doc(db, `artifacts/${firebaseConfig.appId}/users/${userId}/italianCourseProgress/data`);
                const dataToSave = {
                    currentLessonIndex: currentLessonIndex,
                    currentQuestionIndex: currentQuestionIndex,
                    userProgress: userProgress,
                    lastUpdated: new Date().toISOString()
                };

                try {
                    await setDoc(userDocRef, dataToSave, { merge: true });
                    console.log("Progress saved to Firestore for user:", userId);
                    // Clear local storage if saved to cloud successfully
                    localStorage.removeItem('italianCourseProgress');
                    localStorage.removeItem('italianCurrentLessonIndex');
                    localStorage.removeItem('italianCurrentQuestionIndex');
                } catch (e) {
                    console.error("Error saving document to Firestore: ", e);
                    displayAuthError(e); // Pass the error object
                    // Fallback to local storage if Firestore save fails
                    localStorage.setItem('italianCourseProgress', JSON.stringify(userProgress));
                    localStorage.setItem('italianCurrentLessonIndex', currentLessonIndex);
                    localStorage.setItem('italianCurrentQuestionIndex', currentQuestionIndex);
                }
            } else {
                console.warn("User is anonymous or Firebase/Firestore not ready. Progress saved to localStorage.");
                localStorage.setItem('italianCourseProgress', JSON.stringify(userProgress));
                localStorage.setItem('italianCurrentLessonIndex', currentLessonIndex);
                localStorage.setItem('italianCurrentQuestionIndex', currentQuestionIndex);
            }
        }

        async function loadProgress() {
            // Check if Firebase and user are authenticated for cloud loading
            if (auth && db && auth.currentUser && !auth.currentUser.isAnonymous) {
                const userDocRef = doc(db, `artifacts/${firebaseConfig.appId}/users/${userId}/italianCourseProgress/data`);
                try {
                    const docSnap = await getDoc(userDocRef);
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        currentLessonIndex = data.currentLessonIndex || 0;
                        currentQuestionIndex = data.currentQuestionIndex || 0;
                        userProgress = data.userProgress || {};
                        console.log("Progress loaded from Firestore for user:", userId);
                    } else {
                        console.log("No progress found in Firestore for this user. Checking local storage for migration.");
                        // If no cloud progress, check local storage for migration
                        const localProgress = localStorage.getItem('italianCourseProgress');
                        if (localProgress) {
                            userProgress = JSON.parse(localProgress);
                            currentLessonIndex = parseInt(localStorage.getItem('italianCurrentLessonIndex'), 10) || 0;
                            currentQuestionIndex = parseInt(localStorage.getItem('italianCurrentQuestionIndex'), 10) || 0;
                            console.log("Migrating local storage progress to Firestore...");
                            await saveProgress(); // Save local progress to Firestore
                            console.log("Local storage progress migrated to Firestore.");
                        } else {
                             console.log("No local storage progress found either. Starting new.");
                        }
                    }
                } catch (e) {
                    console.error("Error loading document from Firestore: ", e);
                    displayAuthError(e); // Pass the error object
                    // Fallback to local storage on error
                    const savedProgress = localStorage.getItem('italianCourseProgress');
                    if (savedProgress) {
                        userProgress = JSON.parse(savedProgress);
                        currentLessonIndex = parseInt(localStorage.getItem('italianCurrentLessonIndex'), 10) || 0;
                        currentQuestionIndex = parseInt(localStorage.getItem('italianCurrentQuestionIndex'), 10) || 0;
                    }
                }
            } else {
                // If anonymous or Firebase not ready, always load from local storage
                console.warn("User is anonymous or Firebase/Firestore not ready. Loading progress from localStorage.");
                const savedProgress = localStorage.getItem('italianCourseProgress');
                const savedLessonIndex = localStorage.getItem('italianCurrentLessonIndex');
                const savedQuestionIndex = localStorage.getItem('italianCurrentQuestionIndex');

                if (savedProgress) {
                    userProgress = JSON.parse(savedProgress);
                }
                if (savedLessonIndex) {
                    currentLessonIndex = parseInt(savedLessonIndex, 10);
                }
                if (savedQuestionIndex) {
                    currentQuestionIndex = parseInt(savedQuestionIndex, 10);
                }
            }
            updateProgressBar(); // Ensure progress bar is updated after loading
        }


        function updateProgressBar() {
            const totalLessons = courses.length;
            const completedLessons = Object.keys(userProgress).length;
            let progressPercentage = 0;

            if (totalLessons > 0) {
                 if (completedLessons === totalLessons) {
                    progressPercentage = 100;
                } else {
                    progressPercentage = (completedLessons / totalLessons) * 100;
                }
            }
            progressFill.style.width = `${progressPercentage}%`;

            if (currentLessonIndex < courses.length) {
                const currentLesson = courses[currentLessonIndex];
                const totalQuestionsInLesson = currentLesson.questions.length;
                lessonProgressText.textContent = `Lesson ${currentLessonIndex + 1}/${totalLessons} - Question ${currentQuestionIndex + 1}/${totalQuestionsInLesson}`;
            } else {
                lessonProgressText.textContent = `Course Completed!`;
            }
        }

        function showScreen(screenToShow) {
            homeScreen.classList.add('hidden');
            lessonScreen.classList.add('hidden');
            questionScreen.classList.add('hidden');
            courseCompleteScreen.classList.add('hidden');
            screenToShow.classList.remove('hidden');
            updateProgressBar();
        }

        async function startCourse() {
            // Ensure audio context is running on user gesture
            resumeAudioContext();

            if (!isAuthReady) {
                console.log("Authentication not ready. Waiting to start course.");
                return;
            }
            if (currentLessonIndex >= courses.length) {
                showScreen(courseCompleteScreen);
            } else {
                showScreen(lessonScreen);
                renderLesson();
            }
        }

        function renderLesson() {
            const lesson = courses[currentLessonIndex];
            lessonTitle.textContent = lesson.title;
            lessonDescription.textContent = lesson.description;
            continueLessonBtn.textContent = `Start Exercises`;

            vocabularyList.innerHTML = '<h3 class="text-xl font-semibold text-gray-700 mb-4">New Vocabulary:</h3>';
            if (lesson.vocabulary && lesson.vocabulary.length > 0) {
                lesson.vocabulary.forEach(item => {
                    const vocabDiv = document.createElement('div');
                    vocabDiv.classList.add('vocabulary-item');
                    vocabDiv.innerHTML = `
                        <span class="vocabulary-word">${item.word}</span>
                        <span class="vocabulary-translation">${item.translation}</span>
                    `;
                    vocabularyList.appendChild(vocabDiv);
                });
            } else {
                const noVocab = document.createElement('p');
                noVocab.textContent = "No new vocabulary for this lesson.";
                noVocab.classList.add('text-gray-500');
                vocabularyList.appendChild(noVocab);
            }

            showScreen(lessonScreen);
        }

        function startCurrentLesson() {
            showScreen(questionScreen);
            renderQuestion();
        }

        function renderQuestion() {
            feedbackMessage.classList.add('hidden');
            nextQuestionBtn.classList.add('hidden');
            checkAnswerBtn.classList.remove('hidden');
            answerInput.value = '';
            selectedChoice = null;
            speechDisplay.textContent = 'Press \'Start Speaking\' to begin...';
            speechStatus.classList.add('hidden');
            startSpeakingBtn.classList.remove('hidden');
            noSpeechSupportMessage.classList.add('hidden');
            skipSpeakingBtn.classList.add('hidden');

            choicesContainer.classList.add('hidden');
            answerInput.classList.add('hidden');
            speakingExerciseContainer.classList.add('hidden');

            const lesson = courses[currentLessonIndex];
            const question = lesson.questions[currentQuestionIndex];

            questionText.textContent = question.text;

            if (question.type === "multiple-choice") {
                choicesContainer.classList.remove('hidden');
                choicesContainer.innerHTML = '';
                question.choices.forEach((choice, index) => {
                    const choiceBtn = document.createElement('button');
                    choiceBtn.classList.add('choice-btn');
                    choiceBtn.innerHTML = `<span class="choice-number">${index + 1}</span><span>${choice}</span>`;
                    choiceBtn.dataset.choice = choice;
                    choiceBtn.addEventListener('click', () => selectChoice(choiceBtn));
                    choicesContainer.appendChild(choiceBtn);
                });
            } else if (question.type === "translation-input") {
                answerInput.classList.remove('hidden');
                answerInput.focus();
            } else if (question.type === "speaking") {
                speakingExerciseContainer.classList.remove('hidden');
                skipSpeakingBtn.classList.remove('hidden');
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                if (!SpeechRecognition) {
                    startSpeakingBtn.classList.add('hidden');
                    noSpeechSupportMessage.classList.remove('hidden');
                    speechDisplay.textContent = 'Cannot perform speaking exercise: Speech recognition is not supported.';
                } else {
                    noSpeechSupportMessage.classList.add('hidden');
                }
            }
            updateProgressBar();
        }

        function selectChoice(button) {
            document.querySelectorAll('.choice-btn').forEach(btn => {
                btn.classList.remove('selected', 'correct', 'incorrect');
            });
            button.classList.add('selected');
            selectedChoice = button.dataset.choice;
        }

        function compareAnswersFuzzy(userAnswer, correctAnswer) {
            const userWords = userAnswer.toLowerCase().split(/\s+/).filter(word => word.length > 0);
            const correctWords = correctAnswer.toLowerCase().split(/\s+/).filter(word => word.length > 0);

            if (correctWords.length === 0) return true;

            let matchedWordsCount = 0;
            const correctWordsSet = new Set(correctWords);

            userWords.forEach(userWord => {
                if (correctWordsSet.has(userWord)) {
                    matchedWordsCount++;
                }
            });

            const matchPercentage = (matchedWordsCount / correctWords.length) * 100;
            return matchPercentage >= FUZZY_MATCH_THRESHOLD;
        }

        function checkAnswer() {
            const lesson = courses[currentLessonIndex];
            const question = lesson.questions[currentQuestionIndex];
            let isCorrect = false;
            let userAnswer = '';

            if (question.type === "multiple-choice") {
                userAnswer = selectedChoice;
                isCorrect = (selectedChoice && selectedChoice.toLowerCase() === question.correctAnswer.toLowerCase());
            } else if (question.type === "translation-input") {
                userAnswer = answerInput.value.trim();
                isCorrect = compareAnswersFuzzy(userAnswer, question.correctAnswer);
            } else if (question.type === "speaking") {
                userAnswer = speechDisplay.textContent.trim();
                if (noSpeechSupportMessage.classList.contains('hidden')) {
                    isCorrect = compareAnswersFuzzy(userAnswer, question.correctAnswer);
                } else {
                    isCorrect = false;
                }
            }

            // Prevent checking if no answer for non-multiple-choice or no choice selected for MC
            if (question.type !== "multiple-choice" && userAnswer === '' && !isCorrect) {
                return;
            }
            if (question.type === "multiple-choice" && selectedChoice === null && !isCorrect) {
                return;
            }

            feedbackMessage.classList.remove('hidden');
            if (isCorrect) {
                const randomMessage = positiveFeedbackMessages[Math.floor(Math.random() * positiveFeedbackMessages.length)];
                feedbackMessage.textContent = randomMessage;
                feedbackMessage.className = 'text-center text-lg font-semibold mt-4 text-green-600';
                playCorrectSound();
                if (question.type === "multiple-choice" && selectedChoice) {
                    const selectedBtn = document.querySelector(`.choice-btn.selected`);
                    if (selectedBtn) selectedBtn.classList.add('correct');
                }
            } else {
                feedbackMessage.textContent = `Incorrect. The correct answer is: "${question.correctAnswer}"`;
                feedbackMessage.className = 'text-center text-lg font-semibold mt-4 text-red-600';
                playIncorrectSound();
                if (question.type === "multiple-choice") {
                    const selectedBtn = document.querySelector(`.choice-btn.selected`);
                    if (selectedBtn) selectedBtn.classList.add('incorrect');
                    document.querySelectorAll('.choice-btn').forEach(btn => {
                        if (btn.dataset.choice.toLowerCase() === question.correctAnswer.toLowerCase()) {
                            btn.classList.add('correct');
                        }
                    });
                }
            }

            checkAnswerBtn.classList.add('hidden');
            nextQuestionBtn.classList.remove('hidden');
        }

        async function nextQuestion() {
            currentQuestionIndex++;
            const lesson = courses[currentLessonIndex];

            if (currentQuestionIndex < lesson.questions.length) {
                renderQuestion();
            } else {
                userProgress[currentLessonIndex] = true; // Mark lesson as completed
                await saveProgress(); // Save progress after lesson completion
                updateProgressBar();
                currentQuestionIndex = 0; // Reset question index for next lesson
                currentLessonIndex++; // Move to next lesson

                if (currentLessonIndex < courses.length) {
                    renderLesson(); // Show next lesson's intro screen
                } else {
                    showScreen(courseCompleteScreen); // Show course complete screen
                }
            }
        }

        async function restartCourse() {
            currentLessonIndex = 0;
            currentQuestionIndex = 0;
            userProgress = {}; // Clear user progress
            await saveProgress(); // Save cleared progress to Firestore
            updateProgressBar();
            showScreen(homeScreen);
        }

        function startSpeaking() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

            if (!SpeechRecognition) {
                console.error("Speech Recognition API not supported in this browser.");
                noSpeechSupportMessage.classList.remove('hidden');
                return;
            }

            if (currentSpeechRecognition) {
                currentSpeechRecognition.stop();
            }

            currentSpeechRecognition = new SpeechRecognition();
            currentSpeechRecognition.lang = 'it-IT';
            currentSpeechRecognition.interimResults = false;
            currentSpeechRecognition.maxAlternatives = 1;

            speechDisplay.textContent = 'Listening...';
            speechStatus.classList.remove('hidden');
            startSpeakingBtn.classList.add('hidden');

            currentSpeechRecognition.onresult = (event) => {
                const speechResult = event.results[0][0].transcript;
                speechDisplay.textContent = speechResult;
                checkAnswer();
            };

            currentSpeechRecognition.onspeechend = () => {
                currentSpeechRecognition.stop();
                speechStatus.classList.add('hidden');
                startSpeakingBtn.classList.remove('hidden');
            };

            currentSpeechRecognition.onerror = (event) => {
                console.error('Speech recognition error:', event.error);
                speechDisplay.textContent = 'Error listening. Please try again.';
                speechStatus.classList.add('hidden');
                startSpeakingBtn.classList.remove('hidden');
                if (event.error === 'not-allowed') {
                    speechDisplay.textContent = 'Microphone permission denied. Please enable it in browser settings.';
                } else if (event.error === 'no-speech') {
                    speechDisplay.textContent = 'No speech detected. Try again.';
                }
            };

            try {
                currentSpeechRecognition.start();
            } catch (e) {
                console.error("Speech recognition start failed:", e);
                speechDisplay.textContent = 'Could not start microphone. Please check permissions.';
                speechStatus.classList.add('hidden');
                startSpeakingBtn.classList.remove('hidden');
            }
        }

        document.addEventListener('keydown', (event) => {
            if (event.key === 'Enter') {
                if (!checkAnswerBtn.classList.contains('hidden')) {
                    checkAnswer();
                } else if (!nextQuestionBtn.classList.contains('hidden')) {
                    nextQuestion();
                }
            } else if (event.key >= '1' && event.key <= '4') {
                if (!questionScreen.classList.contains('hidden')) {
                    const currentQuestion = courses[currentLessonIndex].questions[currentQuestionIndex];
                    if (currentQuestion.type === "multiple-choice" && !choicesContainer.classList.contains('hidden')) {
                        const choiceIndex = parseInt(event.key, 10) - 1;
                        const choiceButtons = choicesContainer.querySelectorAll('.choice-btn');
                        if (choiceIndex >= 0 && choiceIndex < choiceButtons.length) {
                            selectChoice(choiceButtons[choiceIndex]);
                            if (!checkAnswerBtn.classList.contains('hidden')) {
                                checkAnswer();
                            }
                        }
                    }
                }
            }
            // Global keydown listeners for screen progression buttons
            if (event.key === 'Enter') {
                if (!startCourseBtn.classList.contains('hidden')) {
                    startCourse();
                } else if (!continueLessonBtn.classList.contains('hidden')) {
                    startCurrentLesson();
                } else if (!restartCourseBtn.classList.contains('hidden')) {
                    restartCourse();
                }
            }
        });


        // Firebase initialization logic
        if (Object.keys(firebaseConfig).length > 0 && firebaseConfig.apiKey) {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                console.log("Firebase initialized successfully.");

                // Directly attempt anonymous sign-in if no user is currently authenticated
                if (!auth.currentUser) {
                    signInAnonymously(auth).catch((error) => {
                        console.error("Anonymous sign-in error:", error);
                        displayAuthError(error); // Pass the error object to display more specific messages
                    });
                }

                onAuthStateChanged(auth, async (user) => {
                    // Always hide auth-controls on this page regardless of user state
                    if (authControls) authControls.classList.add('hidden');

                    if (user) {
                        userId = user.uid;
                        if (user.isAnonymous) {
                            if (guestPromptBanner) guestPromptBanner.classList.remove('hidden');
                            if (signedInInfo) signedInInfo.classList.add('hidden');
                            if (authStatusSpan) authStatusSpan.textContent = 'Signed in as: Guest (anonymous)';
                            if (userIdDisplaySpan) userIdDisplaySpan.textContent = `User ID: ${userId}`;
                        } else {
                            if (signedInInfo) signedInInfo.classList.remove('hidden');
                            if (guestPromptBanner) guestPromptBanner.classList.add('hidden');
                            if (authStatusSpan) authStatusSpan.textContent = `Signed in as: ${user.email || user.displayName || 'User'}`;
                            if (userIdDisplaySpan) userIdDisplaySpan.textContent = `User ID: ${userId}`;
                        }

                        await loadProgress(); // Load progress for the current user

                    } else {
                        // User is signed out or no user found
                        userId = crypto.randomUUID(); // Assign a new random ID for unauthenticated state
                        if (guestPromptBanner) guestPromptBanner.classList.remove('hidden');
                        if (signedInInfo) signedInInfo.classList.add('hidden');
                        if (authStatusSpan) authStatusSpan.textContent = 'Signed out (Guest)';
                        if (userIdDisplaySpan) userIdDisplaySpan.textContent = `User ID: Not signed in`;

                        userProgress = {}; // Clear progress if no user
                        currentLessonIndex = 0;
                        currentQuestionIndex = 0;
                    }
                    isAuthReady = true; // Mark auth as ready regardless of user state

                    // Determine which screen to show based on progress or initial state
                    if (currentLessonIndex >= courses.length) {
                        showScreen(courseCompleteScreen);
                    } else if (currentLessonIndex === 0 && currentQuestionIndex === 0 && Object.keys(userProgress).length === 0) {
                        showScreen(homeScreen);
                    } else {
                        showScreen(lessonScreen);
                        renderLesson();
                    }
                });

            } catch (initError) {
                console.error("Firebase initialization failed:", initError);
                displayAuthError(initError); // Pass the error object
                isAuthReady = true;
                // Ensure auth is null if initialization fails
                auth = null;
                // Fallback to loading local progress if Firebase init fails
                loadProgress();
                if (currentLessonIndex >= courses.length) {
                    showScreen(courseCompleteScreen);
                } else if (currentLessonIndex === 0 && currentQuestionIndex === 0 && Object.keys(userProgress).length === 0) {
                    showScreen(homeScreen);
                } else {
                    showScreen(lessonScreen);
                    renderLesson();
                }
            }
        } else {
            console.warn("Firebase config not found. Running in local-only mode. Progress will NOT be saved persistently.");
            isAuthReady = true;
            loadProgress(); // Load from local storage immediately if no Firebase config
            if (currentLessonIndex >= courses.length) {
                showScreen(courseCompleteScreen);
            } else if (currentLessonIndex === 0 && currentQuestionIndex === 0 && Object.keys(userProgress).length === 0) {
                showScreen(homeScreen);
            } else {
                showScreen(lessonScreen);
                renderLesson();
            }
        }
    </script>
</body>
</html>
