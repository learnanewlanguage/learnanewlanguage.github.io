<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Italian Language Course</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Tone.js for sound effects -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables for Firebase (provided by Canvas environment)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};

        // Initialize Firebase
        let app;
        let db;
        let auth;
        let userId; // Will hold the current user's ID
        let isAuthReady = false; // Flag to indicate if auth state has been determined

        // Store references to global functions for use in inline event handlers
        window.startCourse = startCourse;
        window.startCurrentLesson = startCurrentLesson;
        window.checkAnswer = checkAnswer;
        window.nextQuestion = nextQuestion;
        window.restartCourse = restartCourse;
        window.startSpeaking = startSpeaking;
        window.signUpWithEmail = signUpWithEmail; // New function for email sign-up
        window.signInWithEmail = signInWithEmail; // New function for email sign-in
        window.signOutUser = signOutUser;

        // Function to display authentication errors
        function displayAuthError(message) {
            const authErrorMessage = document.getElementById('auth-error-message');
            if (authErrorMessage) {
                authErrorMessage.textContent = message;
                authErrorMessage.classList.remove('hidden');
                setTimeout(() => {
                    authErrorMessage.classList.add('hidden');
                    authErrorMessage.textContent = '';
                }, 5000); // Hide after 5 seconds
            }
        }

        // Ensure Firebase app is only initialized once
        if (Object.keys(firebaseConfig).length > 0) {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            // Listen for authentication state changes
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    const userIdDisplay = document.getElementById('user-id-display');
                    const authStatus = document.getElementById('auth-status');
                    const authControls = document.getElementById('auth-controls');
                    const signoutBtn = document.getElementById('signout-btn');

                    if (userIdDisplay) userIdDisplay.textContent = `User ID: ${userId}`;
                    if (authStatus) authStatus.textContent = `Signed in as: ${user.isAnonymous ? 'Anonymous' : user.email || 'User'}`; // Display email for non-anonymous
                    if (authControls) authControls.classList.add('hidden'); // Hide email input and sign-in/up buttons
                    if (signoutBtn) signoutBtn.classList.remove('hidden');


                    // Attempt to load or migrate progress
                    await loadProgress();
                    // If no progress loaded from Firestore, check localStorage for old progress
                    if (Object.keys(userProgress).length === 0 && localStorage.getItem('italianCourseProgress')) {
                        console.log("Migrating local storage progress to Firestore...");
                        const localProgress = JSON.parse(localStorage.getItem('italianCourseProgress'));
                        const localLessonIndex = parseInt(localStorage.getItem('italianCurrentLessonIndex'), 10);
                        const localQuestionIndex = parseInt(localStorage.getItem('italianCurrentQuestionIndex'), 10);

                        userProgress = localProgress;
                        currentLessonIndex = localLessonIndex;
                        currentQuestionIndex = localQuestionIndex;
                        await saveProgress();
                        localStorage.removeItem('italianCourseProgress');
                        localStorage.removeItem('italianCurrentLessonIndex');
                        localStorage.removeItem('italianCurrentQuestionIndex');
                        console.log("Local storage progress migrated to Firestore.");
                    }
                } else {
                    // User is signed out or no user is signed in.
                    userId = crypto.randomUUID();
                    const userIdDisplay = document.getElementById('user-id-display');
                    const authStatus = document.getElementById('auth-status');
                    const authControls = document.getElementById('auth-controls');
                    const signoutBtn = document.getElementById('signout-btn');

                    if (userIdDisplay) userIdDisplay.textContent = `User ID: Not signed in`;
                    if (authStatus) authStatus.textContent = 'Signed out';
                    if (authControls) authControls.classList.remove('hidden'); // Show email input and sign-in/up buttons
                    if (signoutBtn) signoutBtn.classList.add('hidden');
                    console.log("User is signed out or anonymous session expired.");

                    if (!isAuthReady) {
                        await signInAnonymously(auth).catch((error) => {
                            console.error("Anonymous sign-in error:", error);
                            displayAuthError(error.message);
                        });
                    }
                    userProgress = {};
                    currentLessonIndex = 0;
                    currentQuestionIndex = 0;
                }
                isAuthReady = true;
                if (currentLessonIndex === 0 && currentQuestionIndex === 0 && Object.keys(userProgress).length === 0) {
                    showScreen(homeScreen);
                } else if (currentLessonIndex >= courses.length) {
                    showScreen(courseCompleteScreen);
                } else {
                    showScreen(lessonScreen);
                    renderLesson();
                }
            });

            const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
            if (initialAuthToken) {
                try {
                    await signInWithCustomToken(auth, initialAuthToken);
                } catch (error) {
                    console.error("Custom token sign-in error:", error);
                    displayAuthError(error.message);
                }
            } else if (!auth.currentUser) {
                await signInAnonymously(auth).catch((error) => {
                    console.error("Anonymous sign-in on initial load error:", error);
                    displayAuthError(error.message);
                });
            }
        } else {
            console.warn("Firebase config not found. Running in local-only mode. Progress will NOT be saved persistently.");
            isAuthReady = true;
            loadProgress();
            if (currentLessonIndex === 0 && currentQuestionIndex === 0 && Object.keys(userProgress).length === 0) {
                showScreen(homeScreen);
            } else if (currentLessonIndex >= courses.length) {
                showScreen(courseCompleteScreen);
            } else {
                showScreen(lessonScreen);
                renderLesson();
            }
        }

        // Email/Password Authentication Functions
        async function signUpWithEmail() {
            const email = document.getElementById('email-input').value;
            const password = document.getElementById('password-input').value;
            if (!email || !password) {
                displayAuthError("Please enter both email and password.");
                return;
            }
            try {
                await createUserWithEmailAndPassword(auth, email, password);
                console.log("User signed up with email!");
            } catch (error) {
                console.error("Email sign-up error:", error);
                displayAuthError(error.message);
            }
        }

        async function signInWithEmail() {
            const email = document.getElementById('email-input').value;
            const password = document.getElementById('password-input').value;
            if (!email || !password) {
                displayAuthError("Please enter both email and password.");
                return;
            }
            try {
                await signInWithEmailAndPassword(auth, email, password);
                console.log("User signed in with email!");
            } catch (error) {
                console.error("Email sign-in error:", error);
                displayAuthError(error.message);
            }
        }

        async function signOutUser() {
            try {
                await signOut(auth);
                console.log("User signed out.");
            } catch (error) {
                console.error("Sign out error:", error);
                displayAuthError(error.message);
            }
        }

        // The rest of your existing JavaScript code (courses array, game logic functions)

        const courses = [
            {
                title: "Lesson 1: Basic Greetings ðŸ‘‹",
                description: "Learn how to say hello, goodbye, and thank you.",
                vocabulary: [
                    { word: "Ciao", translation: "Hello / Goodbye" },
                    { word: "Grazie", translation: "Thank you" },
                    { word: "Prego", translation: "You're welcome / Please" },
                    { word: "Arrivederci", translation: "Goodbye" }
                ],
                questions: [
                    { type: "multiple-choice", text: "How do you say 'Hello' in Italian? ðŸ‘‹", choices: ["Ciao", "Grazie", "Prego", "Arrivederci"], correctAnswer: "Ciao" },
                    { type: "multiple-choice", text: "What does 'Grazie' mean? ðŸ™", choices: ["Hello", "Thank you", "Please", "Goodbye"], correctAnswer: "Thank you" },
                    { type: "translation-input", text: "Translate 'Please' into Italian:", correctAnswer: "Per favore" },
                    { type: "speaking", text: "Say 'Goodbye' in Italian: ðŸ‘‹", correctAnswer: "Arrivederci" }
                ]
            },
            {
                title: "Lesson 2: Numbers 1-5 ðŸ”¢",
                description: "Learn to count from one to five.",
                vocabulary: [
                    { word: "Uno", translation: "One" },
                    { word: "Due", translation: "Two" },
                    { word: "Tre", translation: "Three" },
                    { word: "Quattro", translation: "Four" },
                    { word: "Cinque", translation: "Five" }
                ],
                questions: [
                    { type: "multiple-choice", text: "What is 'One' in Italian? â˜ï¸", choices: ["Due", "Uno", "Tre", "Quattro"], correctAnswer: "Uno" },
                    { type: "speaking", text: "Say 'Two' in Italian:âœŒï¸", correctAnswer: "Due" },
                    { type: "translation-input", text: "Translate 'Three' into Italian:", correctAnswer: "Tre" },
                    { type: "translation-input", text: "Translate 'Four' into Italian:", correctAnswer: "Quattro" },
                    { type: "multiple-choice", text: "What is 'Cinque'? ðŸ–ï¸", choices: ["Three", "Four", "Five", "Six"], correctAnswer: "Five" }
                ]
            },
            {
                title: "Lesson 3: Common Phrases ðŸ—£ï¸",
                description: "Learn useful everyday phrases.",
                vocabulary: [
                    { word: "SÃ¬", translation: "Yes" },
                    { word: "No", translation: "No" },
                    { word: "Scusi", translation: "Excuse me / Sorry (formal)" },
                    { word: "Mi dispiace", translation: "I'm sorry" },
                    { word: "Per favore", translation: "Please" }
                ],
                questions: [
                    { type: "translation-input", text: "Translate 'Yes' into Italian: âœ…", correctAnswer: "SÃ¬" },
                    { type: "speaking", text: "Say 'No' in Italian:âŒ", correctAnswer: "No" },
                    { type: "multiple-choice", text: "How do you say 'Excuse me' (formal)? ðŸ™‡", choices: ["Scusi", "Aiuto", "Acqua", "Pane"], correctAnswer: "Scusi" },
                    { type: "multiple-choice", text: "What does 'Mi dispiace' mean? ðŸ˜”", choices: ["I'm happy", "I'm sorry", "I'm hungry", "I'm tired"], correctAnswer: "I'm sorry" }
                ]
            }
        ];

        let currentLessonIndex = 0;
        let currentQuestionIndex = 0;
        let userProgress = {};
        let selectedChoice = null;
        let currentSpeechRecognition = null;

        const homeScreen = document.getElementById('home-screen');
        const lessonScreen = document.getElementById('lesson-screen');
        const questionScreen = document.getElementById('question-screen');
        const courseCompleteScreen = document.getElementById('course-complete-screen');

        const startCourseBtn = document.getElementById('start-course-btn');
        const continueLessonBtn = document.getElementById('continue-lesson-btn');
        const lessonTitle = document.getElementById('lesson-title');
        const lessonDescription = document.getElementById('lesson-description');
        const vocabularyList = document.getElementById('vocabulary-list');

        const questionText = document.getElementById('question-text');
        const choicesContainer = document.getElementById('choices-container');
        const answerInput = document.getElementById('answer-input');
        const feedbackMessage = document.getElementById('feedback-message');
        const checkAnswerBtn = document.getElementById('check-answer-btn');
        const nextQuestionBtn = document.getElementById('next-question-btn');
        const restartCourseBtn = document.getElementById('restart-course-btn');
        const progressFill = document.getElementById('progress-fill');
        const lessonProgressText = document.getElementById('lesson-progress-text');

        const speakingExerciseContainer = document.getElementById('speaking-exercise-container');
        const speechDisplay = document.getElementById('speech-display');
        const startSpeakingBtn = document.getElementById('start-speaking-btn');
        const speechStatus = document.getElementById('speech-status');
        const noSpeechSupportMessage = document.getElementById('no-speech-support-message');
        const skipSpeakingBtn = document.getElementById('skip-speaking-btn');

        const FUZZY_MATCH_THRESHOLD = 70;

        const positiveFeedbackMessages = [
            "Fantastic!", "You got this!", "Excellent!", "Keep up the great work!", "Perfect!"
        ];

        const correctSynth = new Tone.Synth().toDestination();
        const incorrectSynth = new Tone.Synth().toDestination();

        function playCorrectSound() {
            correctSynth.triggerAttackRelease("C5", "8n");
        }

        function playIncorrectSound() {
            incorrectSynth.triggerAttackRelease("C3", "16n");
        }

        async function saveProgress() {
            if (!db || !userId || !auth.currentUser) {
                console.warn("Firestore or user not ready. Progress not saved to cloud.");
                localStorage.setItem('italianCourseProgress', JSON.stringify(userProgress));
                localStorage.setItem('italianCurrentLessonIndex', currentLessonIndex);
                localStorage.setItem('italianCurrentQuestionIndex', currentQuestionIndex);
                return;
            }

            const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/italianCourseProgress/data`);
            const dataToSave = {
                currentLessonIndex: currentLessonIndex,
                currentQuestionIndex: currentQuestionIndex,
                userProgress: userProgress,
                lastUpdated: new Date().toISOString()
            };

            try {
                await setDoc(userDocRef, dataToSave, { merge: true });
                console.log("Progress saved to Firestore.");
            } catch (e) {
                console.error("Error saving document: ", e);
                displayAuthError("Error saving progress: " + e.message);
            }
        }

        async function loadProgress() {
            if (!db || !userId || !auth.currentUser) {
                console.warn("Firestore or user not ready. Loading progress from localStorage.");
                const savedProgress = localStorage.getItem('italianCourseProgress');
                const savedLessonIndex = localStorage.getItem('italianCurrentLessonIndex');
                const savedQuestionIndex = localStorage.getItem('italianCurrentQuestionIndex');

                if (savedProgress) {
                    userProgress = JSON.parse(savedProgress);
                }
                if (savedLessonIndex) {
                    currentLessonIndex = parseInt(savedLessonIndex, 10);
                }
                if (savedQuestionIndex) {
                    currentQuestionIndex = parseInt(savedQuestionIndex, 10);
                }
                updateProgressBar();
                return;
            }

            const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/italianCourseProgress/data`);
            try {
                const docSnap = await getDoc(userDocRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    currentLessonIndex = data.currentLessonIndex || 0;
                    currentQuestionIndex = data.currentQuestionIndex || 0;
                    userProgress = data.userProgress || {};
                    console.log("Progress loaded from Firestore.");
                } else {
                    console.log("No progress found in Firestore for this user.");
                }
            } catch (e) {
                console.error("Error loading document: ", e);
                displayAuthError("Error loading progress: " + e.message);
            }
            updateProgressBar();
        }

        function updateProgressBar() {
            const totalLessons = courses.length;
            const completedLessons = Object.keys(userProgress).length;
            let progressPercentage = 0;

            if (totalLessons > 0) {
                 if (completedLessons === totalLessons) {
                    progressPercentage = 100;
                } else {
                    progressPercentage = (completedLessons / totalLessons) * 100;
                }
            }
            progressFill.style.width = `${progressPercentage}%`;

            if (currentLessonIndex < courses.length) {
                const currentLesson = courses[currentLessonIndex];
                const totalQuestionsInLesson = currentLesson.questions.length;
                lessonProgressText.textContent = `Lesson ${currentLessonIndex + 1}/${totalLessons} - Question ${currentQuestionIndex + 1}/${totalQuestionsInLesson}`;
            } else {
                lessonProgressText.textContent = `Course Completed!`;
            }
        }

        function showScreen(screenToShow) {
            homeScreen.classList.add('hidden');
            lessonScreen.classList.add('hidden');
            questionScreen.classList.add('hidden');
            courseCompleteScreen.classList.add('hidden');
            screenToShow.classList.remove('hidden');
            updateProgressBar();
        }

        async function startCourse() {
            if (!isAuthReady) {
                console.log("Authentication not ready. Waiting to start course.");
                return;
            }
            if (currentLessonIndex >= courses.length) {
                showScreen(courseCompleteScreen);
            } else {
                showScreen(lessonScreen);
                renderLesson();
            }
        }

        function renderLesson() {
            const lesson = courses[currentLessonIndex];
            lessonTitle.textContent = lesson.title;
            lessonDescription.textContent = lesson.description;
            continueLessonBtn.textContent = `Start Exercises`;

            vocabularyList.innerHTML = '<h3 class="text-xl font-semibold text-gray-700 mb-4">New Vocabulary:</h3>';
            if (lesson.vocabulary && lesson.vocabulary.length > 0) {
                lesson.vocabulary.forEach(item => {
                    const vocabDiv = document.createElement('div');
                    vocabDiv.classList.add('vocabulary-item');
                    vocabDiv.innerHTML = `
                        <span class="vocabulary-word">${item.word}</span>
                        <span class="vocabulary-translation">${item.translation}</span>
                    `;
                    vocabularyList.appendChild(vocabDiv);
                });
            } else {
                const noVocab = document.createElement('p');
                noVocab.textContent = "No new vocabulary for this lesson.";
                noVocab.classList.add('text-gray-500');
                vocabularyList.appendChild(noVocab);
            }

            showScreen(lessonScreen);
        }

        function startCurrentLesson() {
            showScreen(questionScreen);
            renderQuestion();
        }

        function renderQuestion() {
            feedbackMessage.classList.add('hidden');
            nextQuestionBtn.classList.add('hidden');
            checkAnswerBtn.classList.remove('hidden');
            answerInput.value = '';
            selectedChoice = null;
            speechDisplay.textContent = 'Press \'Start Speaking\' to begin...';
            speechStatus.classList.add('hidden');
            startSpeakingBtn.classList.remove('hidden');
            noSpeechSupportMessage.classList.add('hidden');
            skipSpeakingBtn.classList.add('hidden');

            choicesContainer.classList.add('hidden');
            answerInput.classList.add('hidden');
            speakingExerciseContainer.classList.add('hidden');

            const lesson = courses[currentLessonIndex];
            const question = lesson.questions[currentQuestionIndex];

            questionText.textContent = question.text;

            if (question.type === "multiple-choice") {
                choicesContainer.classList.remove('hidden');
                choicesContainer.innerHTML = '';
                question.choices.forEach((choice, index) => {
                    const choiceBtn = document.createElement('button');
                    choiceBtn.classList.add('choice-btn');
                    choiceBtn.innerHTML = `<span class="choice-number">${index + 1}</span><span>${choice}</span>`;
                    choiceBtn.dataset.choice = choice;
                    choiceBtn.addEventListener('click', () => selectChoice(choiceBtn));
                    choicesContainer.appendChild(choiceBtn);
                });
            } else if (question.type === "translation-input") {
                answerInput.classList.remove('hidden');
                answerInput.focus();
            } else if (question.type === "speaking") {
                speakingExerciseContainer.classList.remove('hidden');
                skipSpeakingBtn.classList.remove('hidden');
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                if (!SpeechRecognition) {
                    startSpeakingBtn.classList.add('hidden');
                    noSpeechSupportMessage.classList.remove('hidden');
                    speechDisplay.textContent = 'Cannot perform speaking exercise: Speech recognition is not supported.';
                } else {
                    noSpeechSupportMessage.classList.add('hidden');
                }
            }
            updateProgressBar();
        }

        function selectChoice(button) {
            document.querySelectorAll('.choice-btn').forEach(btn => {
                btn.classList.remove('selected', 'correct', 'incorrect');
            });
            button.classList.add('selected');
            selectedChoice = button.dataset.choice;
        }

        function compareAnswersFuzzy(userAnswer, correctAnswer) {
            const userWords = userAnswer.toLowerCase().split(/\s+/).filter(word => word.length > 0);
            const correctWords = correctAnswer.toLowerCase().split(/\s+/).filter(word => word.length > 0);

            if (correctWords.length === 0) return true;

            let matchedWordsCount = 0;
            const correctWordsSet = new Set(correctWords);

            userWords.forEach(userWord => {
                if (correctWordsSet.has(userWord)) {
                    matchedWordsCount++;
                }
            });

            const matchPercentage = (matchedWordsCount / correctWords.length) * 100;
            return matchPercentage >= FUZZY_MATCH_THRESHOLD;
        }

        function checkAnswer() {
            const lesson = courses[currentLessonIndex];
            const question = lesson.questions[currentQuestionIndex];
            let isCorrect = false;
            let userAnswer = '';

            if (question.type === "multiple-choice") {
                userAnswer = selectedChoice;
                isCorrect = (selectedChoice && selectedChoice.toLowerCase() === question.correctAnswer.toLowerCase());
            } else if (question.type === "translation-input") {
                userAnswer = answerInput.value.trim();
                isCorrect = compareAnswersFuzzy(userAnswer, question.correctAnswer);
            } else if (question.type === "speaking") {
                userAnswer = speechDisplay.textContent.trim();
                if (noSpeechSupportMessage.classList.contains('hidden')) {
                    isCorrect = compareAnswersFuzzy(userAnswer, question.correctAnswer);
                } else {
                    isCorrect = false;
                }
            }

            if (question.type !== "multiple-choice" && userAnswer === '' && !isCorrect) {
                return;
            }
            if (question.type === "multiple-choice" && selectedChoice === null && !isCorrect) {
                return;
            }

            feedbackMessage.classList.remove('hidden');
            if (isCorrect) {
                const randomMessage = positiveFeedbackMessages[Math.floor(Math.random() * positiveFeedbackMessages.length)];
                feedbackMessage.textContent = randomMessage;
                feedbackMessage.className = 'text-center text-lg font-semibold mt-4 text-green-600';
                playCorrectSound();
                if (question.type === "multiple-choice" && selectedChoice) {
                    const selectedBtn = document.querySelector(`.choice-btn.selected`);
                    if (selectedBtn) selectedBtn.classList.add('correct');
                }
            } else {
                feedbackMessage.textContent = `Incorrect. The correct answer is: "${question.correctAnswer}"`;
                feedbackMessage.className = 'text-center text-lg font-semibold mt-4 text-red-600';
                playIncorrectSound();
                if (question.type === "multiple-choice") {
                    const selectedBtn = document.querySelector(`.choice-btn.selected`);
                    if (selectedBtn) selectedBtn.classList.add('incorrect');
                    document.querySelectorAll('.choice-btn').forEach(btn => {
                        if (btn.dataset.choice.toLowerCase() === question.correctAnswer.toLowerCase()) {
                            btn.classList.add('correct');
                        }
                    });
                }
            }

            checkAnswerBtn.classList.add('hidden');
            nextQuestionBtn.classList.remove('hidden');
        }

        async function nextQuestion() {
            currentQuestionIndex++;
            const lesson = courses[currentLessonIndex];

            if (currentQuestionIndex < lesson.questions.length) {
                renderQuestion();
            } else {
                userProgress[currentLessonIndex] = true;
                await saveProgress();
                updateProgressBar();
                currentQuestionIndex = 0;
                currentLessonIndex++;

                if (currentLessonIndex < courses.length) {
                    renderLesson();
                } else {
                    showScreen(courseCompleteScreen);
                }
            }
        }

        async function restartCourse() {
            currentLessonIndex = 0;
            currentQuestionIndex = 0;
            userProgress = {};
            await saveProgress();
            updateProgressBar();
            showScreen(homeScreen);
        }

        function startSpeaking() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

            if (!SpeechRecognition) {
                console.error("Speech Recognition API not supported in this browser.");
                noSpeechSupportMessage.classList.remove('hidden');
                return;
            }

            if (currentSpeechRecognition) {
                currentSpeechRecognition.stop();
            }

            currentSpeechRecognition = new SpeechRecognition();
            currentSpeechRecognition.lang = 'it-IT';
            currentSpeechRecognition.interimResults = false;
            currentSpeechRecognition.maxAlternatives = 1;

            speechDisplay.textContent = 'Listening...';
            speechStatus.classList.remove('hidden');
            startSpeakingBtn.classList.add('hidden');

            currentSpeechRecognition.onresult = (event) => {
                const speechResult = event.results[0][0].transcript;
                speechDisplay.textContent = speechResult;
                checkAnswer();
            };

            currentSpeechRecognition.onspeechend = () => {
                currentSpeechRecognition.stop();
                speechStatus.classList.add('hidden');
                startSpeakingBtn.classList.remove('hidden');
            };

            currentSpeechRecognition.onerror = (event) => {
                console.error('Speech recognition error:', event.error);
                speechDisplay.textContent = 'Error listening. Please try again.';
                speechStatus.classList.add('hidden');
                startSpeakingBtn.classList.remove('hidden');
                if (event.error === 'not-allowed') {
                    speechDisplay.textContent = 'Microphone permission denied. Please enable it in browser settings.';
                } else if (event.error === 'no-speech') {
                    speechDisplay.textContent = 'No speech detected. Try again.';
                }
            };

            try {
                currentSpeechRecognition.start();
            } catch (e) {
                console.error("Speech recognition start failed:", e);
                speechDisplay.textContent = 'Could not start microphone. Please check permissions.';
                speechStatus.classList.add('hidden');
                startSpeakingBtn.classList.remove('hidden');
            }
        }

        document.addEventListener('keydown', (event) => {
            if (event.key === 'Enter') {
                if (!checkAnswerBtn.classList.contains('hidden')) {
                    checkAnswer();
                } else if (!nextQuestionBtn.classList.contains('hidden')) {
                    nextQuestion();
                } else if (!startCourseBtn.classList.contains('hidden')) {
                    startCourse();
                } else if (!continueLessonBtn.classList.contains('hidden')) {
                    startCurrentLesson();
                } else if (!restartCourseBtn.classList.contains('hidden')) {
                    restartCourse();
                } else if (document.activeElement === document.getElementById('email-input') || document.activeElement === document.getElementById('password-input')) {
                     // If focus is on email/password inputs, attempt sign-in by default
                    if (document.activeElement === document.getElementById('password-input') && !document.getElementById('auth-controls').classList.contains('hidden')) {
                        signInWithEmail();
                    }
                }
            } else if (event.key >= '1' && event.key <= '4') {
                if (!questionScreen.classList.contains('hidden')) {
                    const currentQuestion = courses[currentLessonIndex].questions[currentQuestionIndex];
                    if (currentQuestion.type === "multiple-choice" && !choicesContainer.classList.contains('hidden')) {
                        const choiceIndex = parseInt(event.key, 10) - 1;
                        const choiceButtons = choicesContainer.querySelectorAll('.choice-btn');
                        if (choiceIndex >= 0 && choiceIndex < choiceButtons.length) {
                            selectChoice(choiceButtons[choiceIndex]);
                            if (!checkAnswerBtn.classList.contains('hidden')) {
                                checkAnswer();
                            }
                        }
                    }
                }
            }
        });

    </script>
</head>
<body class="selection:bg-green-200 selection:text-green-800">
    <!-- Main application container with responsive padding -->
    <div id="app-container" class="container-wrapper p-4 sm:p-8">

        <!-- User Authentication Status -->
        <div class="flex flex-col md:flex-row justify-between items-center text-sm text-gray-600 mb-4 p-2 bg-gray-50 rounded-lg shadow-sm">
            <span id="auth-status" class="mb-2 md:mb-0">Loading authentication status...</span>
            <span id="user-id-display" class="mb-2 md:mb-0">Loading User ID...</span>
            <div id="auth-controls" class="flex flex-col md:flex-row space-y-2 md:space-y-0 md:space-x-2 w-full md:w-auto mt-4 md:mt-0">
                <input type="email" id="email-input" placeholder="Email" class="p-2 border rounded-md text-gray-800 w-full md:w-auto">
                <input type="password" id="password-input" placeholder="Password" class="p-2 border rounded-md text-gray-800 w-full md:w-auto">
                <button id="signup-email-btn" class="btn btn-primary text-sm w-full md:w-auto" onclick="signUpWithEmail()">Sign Up</button>
                <button id="signin-email-btn" class="btn btn-secondary text-sm w-full md:w-auto" onclick="signInWithEmail()">Sign In</button>
            </div>
            <button id="signout-btn" class="btn btn-secondary text-sm hidden mt-4 md:mt-0 w-full md:w-auto" onclick="signOutUser()">Sign Out</button>
        </div>
        <!-- Authentication Error Message -->
        <div id="auth-error-message" class="hidden text-center text-red-500 text-sm mb-4"></div>


        <!-- Progress Info and Bar -->
        <div class="flex items-center mb-4">
            <div id="lesson-progress-text" class="text-gray-700 font-medium mr-4 flex-shrink-0"></div>
            <div class="progress-bar flex-grow">
                <div id="progress-fill" class="progress-fill" style="width: 0%;"></div>
            </div>
        </div>

        <!-- Home Screen -->
        <div id="home-screen" class="text-center">
            <h1 class="text-4xl font-bold text-gray-800 mb-6">Learn Italian</h1>
            <p class="text-lg text-gray-600 mb-8">Your journey to speaking Italian starts here!</p>
            <button id="start-course-btn" class="btn btn-primary text-xl px-8 py-4" onclick="startCourse()">Start Learning</button>
        </div>

        <!-- Lesson Screen -->
        <div id="lesson-screen" class="hidden">
            <h2 id="lesson-title" class="text-3xl font-semibold text-gray-800 mb-4"></h2>
            <p id="lesson-description" class="text-lg text-gray-700 mb-8"></p>
            <div id="vocabulary-list" class="bg-gray-50 p-4 rounded-lg mb-6 shadow-inner">
                <h3 class="text-xl font-semibold text-gray-700 mb-4">New Vocabulary:</h3>
                <!-- Vocabulary items will be rendered here -->
            </div>
            <button id="continue-lesson-btn" class="btn btn-primary w-full" onclick="startCurrentLesson()">Start Exercises</button>
        </div>

        <!-- Question Screen -->
        <div id="question-screen" class="hidden">
            <p id="question-text" class="text-2xl text-gray-800 font-medium mb-6"></p>
            <div id="choices-container" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <!-- Choices will be rendered here -->
            </div>
            <input type="text" id="answer-input" placeholder="Type your answer here..." class="hidden mb-6">

            <!-- Speaking Exercise Controls -->
            <div id="speaking-exercise-container" class="hidden">
                <div id="speech-display" class="w-full text-gray-500">Press 'Start Speaking' to begin...</div>
                <div id="speaking-controls">
                    <button id="start-speaking-btn" class="btn btn-primary" onclick="startSpeaking()">Start Speaking ðŸŽ¤</button>
                    <p id="speech-status" class="text-sm text-gray-600 hidden">Listening...</p>
                    <p id="no-speech-support-message" class="text-sm text-red-500 hidden">Speech recognition not supported in this browser.</p>
                </div>
                <button id="skip-speaking-btn" class="skip-btn hidden" onclick="nextQuestion()">Skip Exercise</button>
            </div>

            <div id="feedback-message" class="text-center text-lg font-semibold mt-4 hidden"></div>
            <button id="check-answer-btn" class="btn btn-primary w-full mt-4" onclick="checkAnswer()">Check Answer</button>
            <button id="next-question-btn" class="btn btn-secondary w-full mt-4 hidden" onclick="nextQuestion()">Next</button>
        </div>

        <!-- Course Complete Screen -->
        <div id="course-complete-screen" class="hidden text-center">
            <h2 class="text-4xl font-bold text-green-600 mb-6">Congratulations!</h2>
            <p class="text-lg text-gray-700 mb-8">You have completed all the lessons in this course.</p>
            <button id="restart-course-btn" class="btn btn-primary text-xl px-8 py-4" onclick="restartCourse()">Restart Course</button>
        </div>
    </div>
</body>
</html>
